% $Author: jannik $
% $Date: 2010-05-13 23:11:04 +0200 (Thu, 13 May 2010) $
% $Revision: 32942 $

% HISTORY:
% 2010-05-14 - Jannik started chapter

%=================================================================
\ifx\wholebook\relax\else
% --------------------------------------------
% Lulu:
	\documentclass[a4paper,10pt,twoside]{book}
	\usepackage[
		papersize={6.13in,9.21in},
		hmargin={.75in,.75in},
		vmargin={.75in,1in},
		ignoreheadfoot
	]{geometry}
	\input{../common.tex}
	\pagestyle{headings}
	\setboolean{lulu}{true}
% --------------------------------------------
% A4:
%	\documentclass[a4paper,11pt,twoside]{book}
%	\input{../common.tex}
%	\usepackage{a4wide}
% --------------------------------------------
    \graphicspath{{figures/} {../figures/}}
	\begin{document}
	% \renewcommand{\nnbb}[2]{} % Disable editorial comments
	\sloppy
\fi
%=================================================================

%=================================================================


\chapter{Gofer: how to script the load of packages}

\section{Package Management system}

%Un système de gestion de versions aide au stockage de versions et garde l'historique d'évolution du système. En plus, il permet de gérer les accès concurrents à un répertoire de code source. Il garde les traces de tous les changements sauvegardés et permet donc à plusieurs développeurs de collaborer. Plus un projet grandit, plus il est important d'utiliser un système de gestion.
%Monticello définit le système de packages et de gestion de versions de Pharo. En Pharo, les classes (changement de superclasse, changement de variables d'instance...) et les méthodes (ajout, modification, suppression) sont les unités élémentaires versionnées par Monticello. Une Source est un serveur HTTP qui permet d'héberger des projets (en particulier des packages) gérés avec Monticello. C'est l'équivalent d'une forge : Elle offre la gestion des contributeurs et leur statuts, des informations de visibilité, un wiki avec RSS feed. Une source offerte à tous est http://www.squeaksource.com/.
%La gestion des versions est faite principalement interactivement. Dans cet article nous présentons Gofer, un outil permettant de scripter la gestion des packages. Il permet d'automatiser certaines actions de versioning.

\section{What is Gofer ?}

%Gofer est un petit outil au dessus de Monticello. Il permet de créer simplement des scripts pour charger, sauvegarder, fusionner, mettre à jour, revenir à une version précédente, recompiler, vérifier les différences, décharger des packages...
%Contrairement aux outils existants, Gofer s'assure que les opérations sont exécutées le plus proprement possible, et le plus clairement possible. Par exemple, après le chargement des packages, Gofer nettoie le code et ne laisse ni classe, ni catégorie vide (une catégorie est une sorte d'identifiant de package). 
%Il permet de charger des packages se situant dans des répertoires différents en une simple opération. En utilisant un certain préfixe, Gofer peut charger la dernière version stable ou la dernière version en cours de développement. Gofer est utilisé par Metacello le gestionnaire de configurations que nous présenterons ultérieurement. 
%Gofer fait parti de la distribution de base depuis la version 1.0 de Pharo. Il est possible de mettre à jour l'outil en évaluant la ligne suivante dans un Workspace, dans l'environnement de Pharo:
%Gofer gofer update

\section{Using Gofer}

%Gofer est simple par son utilisation. Le scénario de chargement de package dans Pharo est toujours le même. Il consiste en trois étapes: d'abord, on spécifie une URL où se trouve le package, ensuite on spécifie le package à charger depuis cette adresse et finalement on invoque les opérations (souvent charger ou sauvegarder).

\subsection{Indicate URL}

%Gofer permet de spécifier une URL d'un répertoire Monticello. Cette dernière a généralement la forme suivante:
%MCHttpRepository 
%    location: 'http://www.squeaksource.com/MonPackage'
%    user: 'pharoUser' 
%    password: 'pharoPwd'
%Pour ceci, les méthodes url:, url:username:password: or directory: sont disponibles. Les deux premières permettent de spécifier des accès HTTP ou FTP, la troisième permet de spécifier tout type d'URL. Cette dernière sera utilisée dans des cas particuliers comme charger des packages depuis un dossier local.
%Il existe dans l'API des méthodes de raccourci, par exemple « squeaksource: », « wiresong: » ou « gemsource: » permettent respectivement de se connecter aux serveurs de squeaksource (http://www.squeaksource.com/), de wiresong (http://source.wiresong.ca/) et de gemsource (http://seaside.gemstone.com/ss/). Ces méthodes sont souvent utilisées car elle pointent vers les serveurs le plus populaires de la communauté.
%En supplément, Gofer déclare par défaut le répertoire local de cache comme une URL. Dans le cas où Gofer n'arriverait pas à charger un package dans l'URL spécifié, il va donc chercher dans le répertoire « cache » à la racine de Pharo. Il est possible de désactiver cette option en utilisant la méthode « disablePackageCache » ou de la réactiver en utilisant la méthode « enablePackageCache ».
%De la même manière, Gofer retourne une erreur si l'un des répertoires n'est pas joignable. Pour ignorer ces erreurs, il suffit d'utiliser la méthode « disableRepositoryErrors ». Pour réactiver cette fonctionnalité, il suffit d'utiliser la méthode « enableRepositoryErrors ».
%Gofer new
%    "on travaille sur le projet GoferLinuxMag"
%    url: 'http://www.squeaksource.com/GoferLinuxMag'	
%    "on spécifie un nom d'utilisateur"
%    username: 'pharoUser'
%    "on spécifie un mot de passe" 
%    password: 'pharoPwd'; 
%    "on ajoute le package souhaité"
%    package:'GoferLinuxMag'; 
%    "on désactive la recherche dans la cache local"
%    disablePackageCache; 
%    "on désactive les erreurs de répertoire"
%    disableRepositoryErrors; 
%    "on charge les packages spécifiés"
%    load.
%"on exécute la commande open"
%(Smalltalk at: #ButtonsBar) open.
%Ce code charge un ensemble de boutons permettant chacun de charger des projets différents. Vous pouvez regarder le code, le modifier ou en ajouter. Le résultat du message « open » donne la figure suivante:
%/// Image : resultButtonsBar.png ///
%Nous vous encourageons à modifier ce projet avec des scripts différents, et à profiter de l'API de Gofer pour gérer vos sources délocalisée.

\subsection{Specify package}

%Une fois l'URL spécifiée et les options définies, on spécifie le ou les packages sur lesquels on souhaite travailler. Pour cela on utilise la méthode « version: » pour travailler sur une version particulière du package, ou la méthode « package: » pour travailler sur la dernière version du package dans l'ensemble des répertoires donnés. 
%Il est également possible de spécifier des contraintes de chargement de packages. La méthode « package:constraint: » permet de passer un block en paramètre pour définir certaines conditions.
%Par exemple, le code suivant permet de récupérer la dernière version du package «GoferLinuxMag» sauvegardée par le développeur nommé « jannik_laval ».
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag' constraint: [ :version | version author = 'jannik_laval' ];
%    load
%Un deuxième exemple qui récupère la version 2 du package «GoferLinuxMag»:
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    version: 'GoferLinuxMag-jannik_laval.2';
%    load

\subsection{Do actions}
%Une fois l'instance de Gofer paramétré, nous pouvons faire de multiple manipulations. Dans ce paragraphe, nous listons les actions possibles suivies d'une courte description. Certaines seront détaillées plus loin dans l'article.
%
%load
%charge les packages spécifiés dans Pharo
%update
%met à jour les versions locales des packages
%merge
%fusionne la version distante avec la version local des packages
%localChanges
%affiche la liste des changements entre la version de base et la version en cours de modification
%remoteChanges
%affiche les changements entre la version en cours et la version distante.
%cleanup
%nettoie les packages spécifiés: il efface les catégories inutiles du package.
%commit / commit:
%sauvegarde les packages sur le serveur distant spécifié. La deuxième méthode permet d'ajouter un message de log.
%revert
%réinitialise les packages dans leur dernières versions chargées
%recompile
%recompile les package
%unload
%supprime de Pharo les packages spécifiés
%fetch
%charge les packages depuis des répertoires distants dans le répertoire local
%push
%sauvegarde les versions de package locales dans le répertoire distant

\subsection{Installing a package}

%Comme nous l'avons évoqué dans les paragraphes précédents, on peut utiliser Gofer pour charger une version spécifique d'un package, charger la dernière version sauvegardée sur le serveur distant, ou encore  charger la dernière version sauvegardé par un programmeur particulier:
%Gofer new
%    "on travaille sur le projet Seaside sauvegardé sur le serveur Squeaksource "
%    squeaksource: 'MetacelloRepository';
%    "on traite la dernière version du package sauvegardé" 
%    package: 'ConfigurationOfSeaside30'; 
%    load	
%"Cette dernière ligne permet de charger le code source de Seaside30"
%(Smalltalk at: #ConfigurationOfSeaside30) load.
%Attention cette action va charger tout Seaside (quelques 70 packages dans votre système), cela prend un certain temps, nous vous suggérons de ne pas le faire immédiatement.

\subsection{\ldots or several}
%Nous pouvons spécifier le chargement de plusieurs packages provenant de plusieurs serveurs différents grâce à Gofer. Le code ci-dessous est à exécuter après celui chargeant Seaside (code précédent). Il charge différents packages provenant de deux serveurs différents. La séquence de chargement est respectée: le script charge dans l'ordre Pier-All, Picasa-Model et Picasa-Seaside.
%Gofer new 		
%    renggli: 'pier';
%    package: 'Pier-All';
%    squeaksource: 'PicasaClient';
%    package: 'Picasa-Model';
%    package: 'Picasa-Seaside';
%    load.
%Cet exemple semble montrer que Pier-All est cherché dans le répertoire Pier de du serveur « renggli », et que Picasa-Model et Picasa-Seaside sont cherchés dans le répertoire PicasaClient de SqueakSource. Or, en réalité, Gofer ne prend pas en compte cet ordre. L'ensemble des packages sont cherchés dans les deux répertoires. En l'absence de numéro de version, le script chargera le package le plus récent sur l'ensemble des deux serveurs.
%On peut donc écrire le script de cette façon:
%Gofer new 
%    squeaksource: 'PicasaClient';		
%    renggli: 'pier';
%    package: 'Pier-All';
%    package: 'Picasa-Model';
%    package: 'Picasa-Seaside';
%    load.
%Dans certains cas, nous souhaitons spécifier une source particulière pour un package. Dans ce cas, nous créons plusieurs script, comme ceci:
%Gofer new
%    squeaksource: 'PicasaClient';
%    package: 'Picasa-Model';
%    package: 'Picasa-Seaside';
%    load.
%Gofer new
%    squeaksource: 'PicasaClientLightbox';
%    package: 'Picasa-Model';
%    package: 'Picasa-Seaside';
%    load.
%Notez que ces scripts chargent les dernières versions des packages, donc ils sont fragiles car si une personne publie un nouveau package avec un bug vous allez le charger. Spécifier la version est une façon de se protéger des changements que l'on ne contrôle pas. 

\subsection{Other protocols}

%Gofer offre également le protocole FTP et la recherche dans le répertoire local. Pour cela nous utilisons les mêmes commandes que les scripts précédents à quelques différences près.
%Pour FTP, nous spécifions l'url précédée de l'entête ftp://
%Gofer new
%    url: 'ftp://wtf-is-ftp.com/code';
%    ...
%Pour un répertoire local, nous utilisons la commande « directory: » suivi du chemin absolu du répertoire contenant les fichiers à charger.
%Gofer new
%    directory: '/home/jlaval/repository';
%    ...
%Pour finir, il est possible de chercher les fichiers dans le répertoire et tous ces sous-répertoires en utilisant « * »
%Gofer new
%    directory: '/home/jlaval/repository/*';
%    ...

\subsection{Synchronizing with a remote server}

%Lorsque l'on travaille avec un package chargé depuis un serveur distant, il est important de synchroniser les versions. La synchronisation fonctionne dans les deux sens: « serveur vers client » pour mettre à jour la version locale, « client vers serveur » pour sauvegarder le travail effectué.
%Dans une partie précédente, nous avons utilisé particulièrement la commande « load » correspondant au sens « serveur vers client ». L'utilisation des autres commandes est similaire: définition d'une URL, définition d'un projet, opération à exécuter.

\paragraph{Merge, update and revert}

%La commande « merge » permet de fusionner la version distance avec la version en cours de travail, en modifiant la version locale. Si il y a des conflits entre les deux versions, une fenêtre s'affiche pour laisser le choix à l'utilisateur. Dans le cas contraire, la fusion se fait en silence.
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%    merge
%La commande « update », quant à elle, met à jour le ou les packages spécifiés de la machine locale avec la version du serveur distant. Cette commande efface les modifications effectuées en locale et non-sauvegardée.
%La commande « revert » met à l'état initial la version locale. En quelques mots, elle charge une nouvelle fois la version précédemment chargée. Elle efface dons les modifications effectuées par l'utilisateur.

\paragraph{commit and commit:}

%Maintenant qu'on a appris à créer un script pour installer un package et manipuler le code en local, on peut sauvegarder les informations sur le serveur. Cette fonctionnalité est assurée par deux méthodes: « commit » et « commit: ». La première sauvegarde sans laisser de commentaires, la seconde prend une chaine de caractère en paramètre pour commenter la version sauvegardée.
%Gofer new
%    " on sauvegarde le packages dans le répertoire GoferLinuxMag "
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%
%    " on commente les changements effectué, et on sauvegarde "
%    commit: 'changed a lot of things'
%Dans le cas d'une sauvegarde, il est important de travailler sur la dernière version du projet. Souvent lorsque plusieurs développeurs travaillent sur le même projet, les versions locales ne sont pas à jour. Une solution pour palier ce problème au moment de la sauvegarde est de fusionner les dernières versions avant de sauvegarder. Voici un exemple:
%Gofer new
%    " on sauvegarde le packages dans le répertoire GoferLinuxMag "
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%
%    "on s'assure de travailler avec la dernière version du package "
%    merge;
%
%    "on commente les changements effectué, et on sauvegarde "
%    commit: 'changed a lot of things'

\paragraph{localChanges and remoteChanges}

%Parfois avant de charger une nouvelle version du package ou de sauvegarder, il peut être utile de regarder les changements effectués en local ou sur le serveur. Pour cela les méthodes « localChanges » et « remoteChanges » permettent pour la première d'afficher les changements entre la dernière version téléchargée et la version en cours de modification ; pour la seconde d'afficher les changements entre la version en cours et la dernière version sauvegardée sur le serveur distant. Ces deux méthodes retournent une liste de changements.
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    "on ajoute la dernière version de GoferLinuxMag"
%    package: 'GoferLinuxMag'; 
%    "on obtient une liste des changements locaux par rapport aux packages spécifiés au dessus"
%    localChanges
%Il est possible d'afficher et de naviguer dans ces changements en utilisant le visualiseur standard de changement de Monticello en utilisant les méthodes « browseLocalChanges » et « browseRemoteChanges »
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    "on ajoute la dernière version de GoferLinuxMag"
%    package: 'GoferLinuxMag';
%    "on navigue dans les changements effectués sur le serveur"
%    browseRemoteChanges		
%/// Image : screenshot.png ///

\paragraph{Unload}

%Gofer permet de supprimer grâce à des scripts des packages de Pharo. La méthode « unload » permet de supprimer proprement les packages spécifiés et l'ensemble de leurs classes et méthodes contenus.
%Le script suivant permet de supprimer le package « GoferLinuxMag » de l'image Pharo:
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%    unload
%A noté qu'il n'est pas possible de supprimer Gofer par ce biais. La commande « Gofer gofer unload » ne fonctionne pas.

\paragraph{Fetch, push: two functions for offline synchronizing}

%Les deux méthodes « fetch » et « push » permettent à Gofer d'avoir le comportement d'un Git. Ce paragraphe montre l'une des fonctionnalités les plus importante de Gofer lorsque l'on travaille hors ligne.
%- « fetch » récupère les packages du serveur distant et remplit le répertoire d'installation local. Il ne les charge  pas dans l'image Pharo mais récupère uniquement les sources d'installations. Cela permet ensuite, hors ligne, d'installer les packages dans Pharo sans connexion internet.
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%    fetch
%Après avoir utilisé cette méthode, il est important lors du chargement du package de ne pas désactiver la recherche dans le répertoire local (méthodes disablePackageCache et enablePackageCache).
%- « push » effectue l'opération inverse: cette méthode prend les packages du répertoire local et les sauvegarde sur le répertoire distant. Après avoir sauvegardé les modifications dans le répertoire local via Monticello, il est possible à la prochaine connexion à Internet de sauvegarder les scripts d'installations sur le serveur distant en toute transparence.
%Gofer new
%    squeaksource: 'GoferLinuxMag';
%    package: 'GoferLinuxMag';
%    push
%Cela permet de constituer une base de données locale et de charger les packages hors connexion: le dossier local est toujours analysé avant le répertoire distant.
%Ainsi avec ces deux fonctions, il est facile de réaliser un script de synchronisation des répertoires local et distant:
%sync
% "synchroniser les répertoires local et distant"
% Gofer new
%     squeaksource: 'GoferLinuxMag';
%     package: 'GoferLinuxMag';
%     push
% Gofer new
%     squeaksource: 'GoferLinuxMag';
%     package: 'GoferLinuxMag';
%     fetch

\subsection{Automate responses}

%Pharo dans son ensemble fournit des méthodes pratiques permettant d'avoir un système complètement maitrisé. Bien que le sujet ici ne soit pas Pharo dans son ensemble, la méthode « valueSupplyingAnswers: » nous intéresse particulièrement. Elle évalue un bloc avec une liste de questions/réponses qui peuvent être appelées durant l'exécution du script dans le bloc (entre crochets). Cela permet de gérer les valeurs à spécifier manuellement et d'y répondre automatiquement. L'exemple suivant montre 4 questions/réponses possibles dans un script.
%[ Gofer new
%	squeaksource: 'Seaside30';
%	package: 'LoadOrderTests';
%	load ]
%	valueSupplyingAnswers: {
%		{'Load Seaside'. True}.
%		{'SqueakSource User Name'. 'pharoUser'}.
%		{'SqueakSource Password'. 'pharoPwd'}.
%		{'Run tests'. false}.
%	}
%Ainsi, il est possible de complètement automatiser les scripts de chargement de vos applications.

\section{Conclusion}

%Nous vous avons présenté Gofer, un outil pour scripter la gestion des packages dans Pharo. Cet outil fonctionne avec l'ensemble des packages sur Pharo, il est donc très facile de créer un script permettant d'installer tous vos packages préférés. 
%Un package indispensable au bon apprentissage de l'environnement Pharo est le programme « ProfStef ». Vous pouvez le charger avec Gofer en exécutant le code suivant:
%Gofer it
%    squeaksource: 'MetacelloRepository';
%    package: 'ConfigurationOfProfStef';
%    load.
%((Smalltalk at: #ConfigurationOfProfStef) project version:'1.0')load.
%(Smalltalk at: #ProfStef) go.
%Amusez-vous bien !

%\begin{code}
%**Leaves**
%52.7% {10502ms} SmallInteger(Integer)>>timesRepeat:
%14.0% {2790ms} ByteString(SequenceableCollection)>>copyReplaceFrom:to:with:
%8.8% {1754ms} UndefinedObject>>DoIt
%7.7% {1534ms} ByteString(SequenceableCollection)>>,
%5.9% {1176ms} ByteString class(String class)>>new:
%\end{code}

%=================================================================

\ifx\wholebook\relax\else\end{document}\fi
%=================================================================

%-----------------------------------------------------------------

